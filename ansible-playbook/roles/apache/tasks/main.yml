---
  - name: Install Apache & Dependencies 
    apt:
      name: ['apache2', 'python3-passlib']
      state: present

  # - name: Install pass-lib
  #   pip:
  #     name: passlib

  - name: Configure Apache
    template:
      src: apache.conf.j2
      dest: /etc/apache2/apache.conf
      owner: admin
      group: admin
      mode: '0644'
    notify: Restart Apache


  - name: Add a user to a password file and ensure permissions are set
    htpasswd:
      path: "{{ apache_htpasswd_path }}"
      name: "{{ item.username }}"
      password: "{{ item.password }}"
      owner: root
      group: www-data
      mode: 0640
    loop: "{{ users }}"

  - name: Configure default app 
    template:
      src: 000-default.conf.j2
      dest: /etc/apache2/sites-enabled/000-default.conf
      owner: admin
      group: admin
      mode: '0644'
    notify: Restart Apache